<!DOCTYPE html>
<html>
<head>
<title>Middleman: Investigating ember's computed properties</title>
<meta content='App.Person = Ember.Object.extend({ firstName: "Tom", surname: "Close", name: function() { return this.get(&#x0027;firstName&#x0027;) + " " + this.get(&#x0027;surname...' name='description'>
<meta charset='utf-8'>
<meta content='width=device-width, initial-scale=1.0' name='viewport'>
<meta content='IE=edge' http-equiv='X-UA-Compatible'>
<meta content='True' name='HandheldFriendly'>
<meta content='Middleman' property='og:site_name'>
<meta content='article' property='og:type'>
<meta content="Investigating ember's computed properties" property='og:title'>
<meta content='App.Person = Ember.Object.extend({ firstName: "Tom", surname: "Close", name: function() { return this.get(&#x0027;firstName&#x0027;) + " " + this.get(&#x0027;surname...' property='og:description'>
<meta content='http://www.example.com/2014/07/16/investigating-ember-s-computed-properties/' property='og:url'>
<meta content='2014-07-16' property='article:published_time'>
<meta content='summary' name='twitter:card'>
<meta content="Investigating ember's computed properties" name='twitter:title'>
<meta content='App.Person = Ember.Object.extend({ firstName: "Tom", surname: "Close", name: function() { return this.get(&#x0027;firstName&#x0027;) + " " + this.get(&#x0027;surname...' name='twitter:description'>
<meta content='http://www.example.com/2014/07/16/investigating-ember-s-computed-properties/' name='twitter:url'>
<link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
<link href="/images/favicon.ico" rel="icon" type="image/ico" />
<link href="/stylesheets/application.css" rel="stylesheet" />
<link href='//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400' rel='stylesheet' type='text/css'>
</head>
<body class='post-template nav-closed'>
<div class='nav'>
<h3 class='nav-title'>Menu</h3>
<a class='nav-close' href='#'>
<span class='hidden'>Close</span>
</a>
<ul>
<li class='nav-home' role='presentation'>
<a href='/'>Home</a>
</li>
</ul>
<a class='subscribe-button icon-feed' href='/feed.xml'>Subscribe</a>
</div>
<span class='nav-cover'></span>

<div class='site-wrapper'>
<pre class="highlight javascript"><code><span class="nx">App</span><span class="p">.</span><span class="nx">Person</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">.</span><span class="nb">Object</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="na">firstName</span><span class="p">:</span> <span class="s2">"Tom"</span><span class="p">,</span>
  <span class="na">surname</span><span class="p">:</span> <span class="s2">"Close"</span><span class="p">,</span>

  <span class="na">name</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'firstName'</span><span class="p">)</span> <span class="o">+</span> <span class="s2">" "</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'surname'</span><span class="p">);</span>
  <span class="p">}.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'firstName'</span><span class="p">,</span> <span class="s1">'surname'</span><span class="p">),</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">tom</span> <span class="o">=</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Person</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>
</code></pre>
<pre class="highlight javascript"><code><span class="nx">tom</span><span class="p">.</span><span class="nx">firstName</span>
<span class="c1">// "Tom"</span>
<span class="nx">tom</span><span class="p">.</span><span class="nx">firstName</span> <span class="o">=</span> <span class="s2">"Thomas"</span>
<span class="c1">// "Thomas"</span>
<span class="nx">tom</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'firstName'</span><span class="p">)</span>
<span class="c1">// "Thomas"</span>
<span class="nx">tom</span><span class="p">.</span><span class="nx">firstName</span> <span class="o">=</span> <span class="s2">"Alan"</span>
<span class="c1">// "Alan"</span>
<span class="nx">tom</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)</span>
<span class="c1">// "Alan Close"</span>
<span class="nx">tom</span><span class="p">.</span><span class="nx">firstName</span> <span class="o">=</span> <span class="s2">"Tom"</span>
<span class="c1">// Error: Assertion Failed: You must use Ember.set() to access this property (of &lt;App.Person:ember381&gt;)</span>
</code></pre>

<p>If we look at the object we see that we now have a few new functions:</p>
<pre class="highlight javascript"><code><span class="nx">tom</span>
<span class="nx">Class</span> <span class="p">{</span><span class="nl">constructor</span><span class="p">:</span> <span class="kd">function</span><span class="p">,</span> <span class="nx">_super</span><span class="err">:</span> <span class="kd">function</span><span class="p">,</span> <span class="nx">firstName</span><span class="err">:</span> <span class="s2">"Tom"</span><span class="p">,</span> <span class="nx">surname</span><span class="err">:</span> <span class="s2">"Close"</span><span class="p">,</span> <span class="nx">title</span><span class="err">:</span> <span class="s2">"Mr"</span><span class="err">â€¦</span><span class="p">}</span>
<span class="c1">// snip</span>
<span class="nx">get</span> <span class="nx">firstName</span><span class="err">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
<span class="nx">set</span> <span class="nx">firstName</span><span class="err">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
<span class="nx">get</span> <span class="nx">surname</span><span class="err">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
<span class="nx">set</span> <span class="nx">surname</span><span class="err">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</code></pre>

<p>Ember has used <code>defineProperty</code> to provide setters and getters for when you call
<code>tom.firstName&#39; and</code>tom.firstName=<code>. The setter will just raise the
error that we hit above; the getter looks in the</code>meta[cache]` for the
stored.</p>

<p>The relevant file here is <code>ember-metal/libs/property-get.js</code>. I&rsquo;m a
little unsure why this isn&rsquo;t triggered when you just do
<code>tom.get(&#39;firstName&#39;)</code> though.</p>

<p>In <code>ember-metal/libs/property-set.js</code> we see that the setter calls
<code>propertyDidChange(obj, keyname)</code> on setting (if the property is a
vanilla non-descriptor sort). This notifies dependent keys, chains and
observers (if anything is watching that key). We can call these
manually.</p>

<p>For the dependent keys, it iterates over the graph (stored in
meta[deps]), calling propertyDidChange on each key. On vanilla keys this
does nothing, but on descriptors it calls <code>.didChange(obj, keyname)</code>.</p>

<p>Calling <code>didChange(obj, keyname)</code> on a ComputedProperty sets the cached
vaule to <code>undefined</code> and removes the dependentKeys.
~~~js
ComputedPropertyPrototype.didChange = function(obj, keyName) {
  // <em>suspended is set via a CP.set to ensure we don&rsquo;t clear
  // the cached value set by the setter
  if (this.</em>cacheable &amp;&amp; this._suspended !== obj) {
    var meta = metaFor(obj);
    if (meta.cache[keyName] !== undefined) {
      meta.cache[keyName] = undefined;
      removeDependentKeys(this, obj, keyName, meta);
    }
  }
};
~~~</p>

<p>RemoveDependentKeys
1. Looks up on the descriptor to see what its dependent keys are
(&lsquo;firstName&rsquo;, &#39;surname&rsquo;)
2. Reduces the count of the property (&#39;name&rsquo;) in the dependent keys.
3. Stops watching.</p>
<pre class="highlight javascript"><code><span class="nx">printMeta</span><span class="p">(</span><span class="nx">tom</span><span class="p">)</span>
<span class="o">==</span> <span class="nx">Cache</span> <span class="o">==</span>
<span class="nx">name</span><span class="err">:</span> <span class="nx">Tom</span> <span class="nx">Close</span>
<span class="o">==</span> <span class="nx">Values</span> <span class="o">==</span>
<span class="nx">firstName</span><span class="err">:</span> <span class="nx">Tom</span>
<span class="nl">surname</span><span class="p">:</span> <span class="nx">Close</span>
<span class="o">==</span> <span class="nx">Watching</span> <span class="o">==</span>
<span class="nx">firstName</span><span class="err">:</span> <span class="mi">1</span>
<span class="nl">surname</span><span class="p">:</span> <span class="mi">1</span>
<span class="o">==</span> <span class="nx">Deps</span> <span class="o">==</span>
<span class="nx">firstName</span><span class="err">:</span>
  <span class="nl">name</span><span class="p">:</span> <span class="mi">1</span>
<span class="nl">surname</span><span class="p">:</span>
  <span class="nl">name</span><span class="p">:</span> <span class="mi">1</span>
<span class="o">==</span> <span class="nx">Chain</span> <span class="nx">watchers</span> <span class="o">==</span>
<span class="o">==</span> <span class="nx">Chains</span> <span class="o">==</span>


<span class="o">&gt;</span> <span class="nx">Em</span><span class="p">.</span><span class="nx">propertyDidChange</span><span class="p">(</span><span class="nx">tom</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">)</span>
<span class="kc">undefined</span>
<span class="o">&gt;</span> <span class="nx">printMeta</span><span class="p">(</span><span class="nx">tom</span><span class="p">)</span>
<span class="o">==</span> <span class="nx">Cache</span> <span class="o">==</span>
<span class="o">==</span> <span class="nx">Values</span> <span class="o">==</span>
<span class="nx">firstName</span><span class="err">:</span> <span class="nx">Tom</span>
<span class="nl">surname</span><span class="p">:</span> <span class="nx">Close</span>
<span class="o">==</span> <span class="nx">Watching</span> <span class="o">==</span>
<span class="nx">firstName</span><span class="err">:</span> <span class="mi">0</span>
<span class="nl">surname</span><span class="p">:</span> <span class="mi">0</span>
<span class="o">==</span> <span class="nx">Deps</span> <span class="o">==</span>
<span class="nx">firstName</span><span class="err">:</span>
  <span class="nl">name</span><span class="p">:</span> <span class="mi">0</span>
<span class="nl">surname</span><span class="p">:</span>
  <span class="nl">name</span><span class="p">:</span> <span class="mi">0</span>
<span class="o">==</span> <span class="nx">Chain</span> <span class="nx">watchers</span> <span class="o">==</span>
<span class="o">==</span> <span class="nx">Chains</span> <span class="o">==</span>
</code></pre>

<p>So that&rsquo;s ok for properties. What about chains?</p>

<p>Aside: defining properties:
~~~js
  // define a simple property
  Ember.defineProperty(contact, &#39;lastName&rsquo;, undefined, &#39;Jolley&rsquo;);</p>

<p>// define a computed property
  Ember.defineProperty(contact, &#39;fullName&rsquo;, Ember.computed(function() {
    return this.firstName+&rsquo; &rsquo;+this.lastName;
  }).property(&#39;firstName&rsquo;, &#39;lastName&rsquo;));
~~~</p>
<pre class="highlight javascript"><code><span class="nx">tom</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'locationName'</span><span class="p">)</span>
<span class="kc">null</span>
<span class="nx">printMeta</span><span class="p">(</span><span class="nx">tom</span><span class="p">)</span>
<span class="o">==</span> <span class="nx">Cache</span> <span class="o">==</span>
<span class="nx">locationName</span><span class="err">:</span> <span class="kc">null</span>
<span class="o">==</span> <span class="nx">Values</span> <span class="o">==</span>
<span class="nx">location</span><span class="err">:</span> <span class="kc">null</span>
<span class="o">==</span> <span class="nx">Watching</span> <span class="o">==</span>
<span class="nx">location</span><span class="p">.</span><span class="nx">name</span><span class="err">:</span>
<span class="nl">location</span><span class="p">:</span> <span class="mi">1</span>
<span class="o">==</span> <span class="nx">Deps</span> <span class="o">==</span>
<span class="nx">location</span><span class="p">.</span><span class="nx">name</span><span class="err">:</span>
  <span class="nl">locationName</span><span class="p">:</span> <span class="mi">1</span>
<span class="o">==</span> <span class="nx">Chain</span> <span class="nx">watchers</span> <span class="o">==</span>
<span class="nx">location</span><span class="err">:</span>
  <span class="mi">0</span><span class="err">:</span>
    <span class="p">{</span><span class="nl">Key</span><span class="p">:</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">Value</span><span class="err">:</span> <span class="kc">null</span><span class="p">,</span> <span class="nb">Object</span><span class="err">:</span> <span class="o">&lt;</span><span class="nx">App</span><span class="p">.</span><span class="nx">Person</span><span class="err">:</span><span class="nx">ember252</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">Watching</span><span class="err">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Count</span><span class="err">:</span> <span class="mi">1</span><span class="p">}</span>
    <span class="o">-&gt;</span> <span class="p">{</span><span class="na">Key</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span> <span class="na">Value</span><span class="p">:</span> <span class="o">&lt;</span><span class="nx">App</span><span class="p">.</span><span class="na">Person</span><span class="p">:</span><span class="nx">ember252</span><span class="o">&gt;</span><span class="p">,</span> <span class="na">Object</span><span class="p">:</span> <span class="kc">undefined</span><span class="p">,</span> <span class="na">Watching</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">Count</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
<span class="o">==</span> <span class="nx">Chains</span> <span class="o">==</span>
<span class="nx">root</span><span class="err">:</span> <span class="p">{</span><span class="nl">Key</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">Value</span><span class="err">:</span> <span class="o">&lt;</span><span class="nx">App</span><span class="p">.</span><span class="nx">Person</span><span class="err">:</span><span class="nx">ember252</span><span class="o">&gt;</span><span class="p">,</span> <span class="nb">Object</span><span class="err">:</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">Watching</span><span class="err">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">Count</span><span class="err">:</span> <span class="mi">0</span><span class="p">}</span>
  <span class="nl">location</span><span class="p">:</span> <span class="p">{</span><span class="nl">Key</span><span class="p">:</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">Value</span><span class="err">:</span> <span class="kc">null</span><span class="p">,</span> <span class="nb">Object</span><span class="err">:</span> <span class="o">&lt;</span><span class="nx">App</span><span class="p">.</span><span class="nx">Person</span><span class="err">:</span><span class="nx">ember252</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">Watching</span><span class="err">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Count</span><span class="err">:</span> <span class="mi">1</span><span class="p">}</span>
    <span class="nl">name</span><span class="p">:</span> <span class="p">{</span><span class="nl">Key</span><span class="p">:</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">Value</span><span class="err">:</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nb">Object</span><span class="err">:</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">Watching</span><span class="err">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">Count</span><span class="err">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="kc">undefined</span>
</code></pre>

<p>ChainNode.chainsWillChange
ChainNode.willChange</p>

<p>seems to just walk the chain lattice, collecting the object/property
pairs to fire the propertyWillChange events on. Which in turn
essentially just fires <code>didChange</code> on the descriptors. Which just clears
the cache and removes the dependent keys</p>

<footer class='site-footer clearfix'>
<section class='copyright'>
<a href='/'>Middleman</a>
&copy;
2015
</section>
<section class='poweredby'>
Casper theme powered by
<a href='https://ghost.org'>Ghost</a>
</section>
</footer>
</div>
<script src="/javascripts/application.js"></script>
</body>
</html>
